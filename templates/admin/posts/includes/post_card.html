{% load admin_urls tz %}
{% localtime on %}
<article class="post-card" data-status="{{ post.status }}">
  <div class="post-card__head">
    <div class="post-card__channel">
      <span>{{ post.channel }}</span>
      <span class="post-card__status">
        <span class="post-card__status-badge">{{ post.get_status_display }}</span>
        {% if post.schedule_mode %}
          <span>{{ post.get_schedule_mode_display }}</span>
        {% endif %}
      </span>
    </div>
    {% if post.scheduled_at %}
      <div class="post-card__status">
        <strong>Publikacja:</strong>
        <time datetime="{{ post.scheduled_at|date:'c' }}">{{ post.scheduled_at|date:"d.m.Y H:i" }}</time>
      </div>
    {% elif post.expires_at %}
      <div class="post-card__status">
        <strong>Wygasa:</strong>
        <time datetime="{{ post.expires_at|date:'c' }}">{{ post.expires_at|date:"d.m.Y H:i" }}</time>
      </div>
    {% endif %}
  </div>
  {% if post.rewrite_status == 'pending' %}
    <div class="post-card__notice post-card__notice--pending">
      ⏳ Korekta GPT w toku — zlecono {{ post.rewrite_requested_display|default:'przed chwilą' }}.
    </div>
  {% elif post.rewrite_status == 'completed' %}
    <div class="post-card__notice post-card__notice--done">
      ✅ Wpis wrócił z korekty GPT{% if post.rewrite_completed_display %} ({{ post.rewrite_completed_display }}){% endif %}.
    </div>
  {% endif %}
  <div class="post-card__preview">
    {% include "partials/telegram_preview.html" with text=post.text media=post.preview_media width='100%' %}
  </div>
  <div class="post-card__meta">
    <div>
      <strong>ID:</strong> {{ post.pk }} • <strong>Duplikat:</strong>
      {% if post.dupe_score is not None %}
        {{ post.dupe_score|floatformat:2 }}
      {% else %}
        –
      {% endif %}
    </div>
    <div><strong>Utworzono:</strong> <time datetime="{{ post.created_at|date:'c' }}">{{ post.created_at|date:"d.m.Y H:i" }}</time></div>
    {% if post.approved_by %}
      <div><strong>Zatwierdził:</strong> {{ post.approved_by }}</div>
    {% endif %}
    {% if post.source_url %}
      <div>
        <strong>Źródło:</strong>
        <a href="{{ post.source_url }}" target="_blank" rel="noopener">
          {{ post.source_url|truncatechars:80 }}
        </a>
      </div>
    {% endif %}
    {% if post.source_entries %}
      <div class="post-card__sources">
        <strong>Źródła mediów:</strong>
        <ul class="post-card__sources-list">
          {% for entry in post.source_entries %}
            <li>
              {% if entry.resolver %}<span class="post-card__badge">{{ entry.resolver }}</span>{% endif %}
              {% with ref=entry.reference %}
                {% if ref.tg_post_url %}
                  <a href="{{ ref.tg_post_url }}" target="_blank" rel="noopener">{{ ref.tg_post_url }}</a>
                {% elif ref.original_url %}
                  <a href="{{ ref.original_url }}" target="_blank" rel="noopener">{{ ref.original_url }}</a>
                {% elif entry.source %}
                  <span>{{ entry.source }}</span>
                {% endif %}
              {% endwith %}
              {% if entry.posted_at %}<span class="post-card__source-meta">{{ entry.posted_at }}</span>{% endif %}
              {% if entry.caption %}<div class="post-card__source-caption">{{ entry.caption }}</div>{% endif %}
              {% if entry.status and entry.status != 'cached' %}<em class="post-card__source-status">({{ entry.status }})</em>{% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
  <div class="post-card__footer">
    <div class="post-card__actions">
      <a href="{{ post.change_url }}" class="post-card__action--primary">Edytuj</a>
      <a href="{{ post.rewrite_url }}" class="post-card__action--secondary">GPT: korekta</a>
      {% if post.publish_now_url %}
        <button
          type="submit"
          formmethod="post"
          formaction="{{ post.publish_now_url }}"
          class="post-card__action--primary"
        >
          Opublikuj teraz
        </button>
      {% endif %}
      {% if post.is_draft and post.approve_url %}
        <button
          type="submit"
          formmethod="post"
          formaction="{{ post.approve_url }}"
          class="post-card__action--primary"
        >
          Akceptuj
        </button>
      {% else %}
        <a href="{{ post.reschedule_url }}" class="post-card__action--secondary">Zmień termin publikacji</a>
      {% endif %}
      <a href="{{ post.delete_url }}" class="post-card__action--danger">Usuń</a>
    </div>
    {% if action_checkbox_name and cl.show_admin_actions %}
    <label class="post-card__selection">
      <input type="checkbox" class="action-select" name="{{ action_checkbox_name }}" value="{{ post.pk }}">
      <span>Do akcji</span>
    </label>
    {% endif %}
  </div>
</article>
{% endlocaltime %}
